import logging
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes, filters, ConversationHandler
import MetaTrader5 as mt5
import os

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (logging)
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
LOGIN, PASSWORD, SERVER = range(3)

# ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
user_sessions = {}

# Ù‚Ø§Ø¦Ù…Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
def main_menu_keyboard():
    return ReplyKeyboardMarkup(
        [
            [KeyboardButton("ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"), KeyboardButton("ğŸ“ˆ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙˆÙ‚")],
            [KeyboardButton("ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯"), KeyboardButton("ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬")]
        ],
        resize_keyboard=True
    )

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù…Ø¹ MT5!\nØ§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:",
        reply_markup=main_menu_keyboard()
    )

async def logout(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id in user_sessions:
        del user_sessions[user_id]
        await update.message.reply_text("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­.", reply_markup=main_menu_keyboard())
    else:
        await update.message.reply_text("Ø£Ù†Øª ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ØµÙ„Ø§Ù‹.", reply_markup=main_menu_keyboard())

async def balance(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    session = user_sessions.get(user_id)
    if session and session['connected']:
        acc_info = mt5.account_info()
        if acc_info:
            await update.message.reply_text(f"Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: {acc_info.balance} USD")
        else:
            await update.message.reply_text("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ.")
    else:
        await update.message.reply_text("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.", reply_markup=main_menu_keyboard())

async def analysis(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    session = user_sessions.get(user_id)
    if session and session['connected']:
        rates = mt5.copy_rates_from_pos("EURUSD", mt5.TIMEFRAME_M1, 0, 1)
        if rates is not None and len(rates) > 0:
            price = rates[0]['close']
            await update.message.reply_text(f"Ø³Ø¹Ø± EURUSD Ø§Ù„Ø­Ø§Ù„ÙŠ: {price}")
        else:
            await update.message.reply_text("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙˆÙ‚.")
    else:
        await update.message.reply_text("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.", reply_markup=main_menu_keyboard())

# ==========================
# Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
# ==========================

async def login_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ MT5 Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:")
    return LOGIN

async def login_account(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['login'] = update.message.text
    await update.message.reply_text("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:")
    return PASSWORD

async def login_password(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['password'] = update.message.text
    await update.message.reply_text("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø®Ø§Ø¯Ù… (Server Name):")
    return SERVER

async def login_server(update: Update, context: ContextTypes.DEFAULT_TYPE):
    server = update.message.text
    login = context.user_data['login']
    password = context.user_data['password']

    # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ MT5
    if mt5.initialize(server=server, login=int(login), password=password):
        user_id = update.effective_user.id
        user_sessions[user_id] = {
            'login': login,
            'server': server,
            'connected': True
        }
        await update.message.reply_text("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!", reply_markup=main_menu_keyboard())
        return ConversationHandler.END
    else:
        await update.message.reply_text("âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.")
        return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.", reply_markup=main_menu_keyboard())
    return ConversationHandler.END

def main():
    TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "8112822168:AAGwqxRY5xZ23pi5PjEhNkytuXLzjaJ1qVI")
    application = ApplicationBuilder().token(TOKEN).build()

    # Ù…Ø­Ø§Ø¯Ø«Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    login_conversation = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„$"), login_start)],
        states={
            LOGIN: [MessageHandler(filters.TEXT & ~filters.COMMAND, login_account)],
            PASSWORD: [MessageHandler(filters.TEXT & ~filters.COMMAND, login_password)],
            SERVER: [MessageHandler(filters.TEXT & ~filters.COMMAND, login_server)],
        },
        fallbacks=[CommandHandler('cancel', cancel)]
    )

    application.add_handler(CommandHandler("start", start))
    application.add_handler(login_conversation)
    application.add_handler(MessageHandler(filters.Regex("^ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬$"), logout))
    application.add_handler(MessageHandler(filters.Regex("^ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯$"), balance))
    application.add_handler(MessageHandler(filters.Regex("^ğŸ“ˆ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙˆÙ‚$"), analysis))

    print("Bot is running...")
    application.run_polling()

if __name__ == "__main__":
    main()
