import os
import requests
import hmac
import hashlib
import time
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler, filters,
    ConversationHandler, ContextTypes
)

# ==== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø§Øª ====
API_KEY, API_SECRET = range(2)
TRADE_ACTION, TRADE_SIZE, TRADE_SL, TRADE_TP = range(10, 14)

# ==== ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ====
user_sessions = {}

# ==== Bybit API ==== 
BYBIT_API_URL = "https://api.bybit.com"

def sign_request(api_key, api_secret, params):
    params['api_key'] = api_key
    params['timestamp'] = int(time.time() * 1000)
    sorted_params = "&".join([f"{k}={params[k]}" for k in sorted(params)])
    signature = hmac.new(
        api_secret.encode(),
        sorted_params.encode(),
        hashlib.sha256
    ).hexdigest()
    params['sign'] = signature
    return params

def bybit_request(endpoint, params, api_key, api_secret, req_type="GET"):
    url = BYBIT_API_URL + endpoint
    params = sign_request(api_key, api_secret, params)
    if req_type == "GET":
        r = requests.get(url, params=params)
    else:
        r = requests.post(url, data=params)
    return r.json()

# ==== Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± ====
def main_menu_keyboard():
    return ReplyKeyboardMarkup(
        [
            [KeyboardButton("ğŸ“ˆ Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚"), KeyboardButton("ğŸ’° Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨")],
            [KeyboardButton("ğŸŸ¢ Ø´Ø±Ø§Ø¡"), KeyboardButton("ğŸ”´ Ø¨ÙŠØ¹")],
            [KeyboardButton("ğŸ” ØªØ¯Ø§ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ"), KeyboardButton("ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬")]
        ],
        resize_keyboard=True
    )

# ==== Ø£ÙˆØ§Ù…Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ====
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id in user_sessions and user_sessions[user_id].get("api_key"):
        await update.message.reply_text("Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ù‹Ø§! Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:", reply_markup=main_menu_keyboard())
        return
    await update.message.reply_text("Ø£Ø¯Ø®Ù„ Bybit API Key Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ:")
    return API_KEY

async def logout(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_sessions.pop(user_id, None)
    await update.message.reply_text("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.", reply_markup=main_menu_keyboard())

# ==== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (API Key Ùˆ Secret) ====
async def get_api_key(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["api_key"] = update.message.text.strip()
    await update.message.reply_text("Ø£Ø¯Ø®Ù„ Bybit API Secret Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ:")
    return API_SECRET

async def get_api_secret(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    context.user_data["api_secret"] = update.message.text.strip()
    user_sessions[user_id] = {
        "api_key": context.user_data["api_key"],
        "api_secret": context.user_data["api_secret"],
        "auto_trade": False
    }
    await update.message.reply_text("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!", reply_markup=main_menu_keyboard())
    return ConversationHandler.END

# ==== Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚ ====
async def market_price(update: Update, context: ContextTypes.DEFAULT_TYPE):
    symbol = "BTCUSDT"
    url = f"{BYBIT_API_URL}/v5/market/tickers?category=linear&symbol={symbol}"
    r = requests.get(url)
    data = r.json()
    price = data['result']['list'][0]['lastPrice'] if data['result']['list'] else "ØºÙŠØ± Ù…ØªÙˆÙØ±"
    await update.message.reply_text(f"Ø³Ø¹Ø± {symbol} Ø§Ù„Ø­Ø§Ù„ÙŠ: {price}")

# ==== Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ ====
async def account_balance(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    session = user_sessions.get(user_id)
    if not session:
        await update.message.reply_text("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.")
        return
    api_key = session["api_key"]
    api_secret = session["api_secret"]

    params = {"accountType": "UNIFIED"}
    resp = bybit_request("/v5/account/wallet-balance", params, api_key, api_secret)
    try:
        usdt_balance = resp["result"]["list"][0]["coin"][0]["walletBalance"]
        await update.message.reply_text(f"Ø±ØµÙŠØ¯Ùƒ (USDT): {usdt_balance}")
    except Exception:
        await update.message.reply_text("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯.")

# ==== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ ====
async def trade_action(update: Update, context: ContextTypes.DEFAULT_TYPE):
    action = update.message.text
    context.user_data["side"] = "Buy" if action == "ğŸŸ¢ Ø´Ø±Ø§Ø¡" else "Sell"
    await update.message.reply_text("ÙƒÙ… Ø­Ø¬Ù… Ø§Ù„ØµÙÙ‚Ø© (Ù…Ø«Ù„Ø§Ù‹ 0.001)ØŸ")
    return TRADE_SIZE

async def trade_size(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        size = float(update.message.text)
        context.user_data["qty"] = size
        await update.message.reply_text("Ø­Ø¯Ø¯ Ø³Ø¹Ø± ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© (Stop Loss) Ø£Ùˆ Ø£Ø±Ø³Ù„ 0 Ù„ØªØ¬Ø§Ù‡Ù„Ù‡:")
        return TRADE_SL
    except ValueError:
        await update.message.reply_text("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­.")
        return TRADE_SIZE

async def trade_sl(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        sl = float(update.message.text)
        context.user_data["stop_loss"] = sl
        await update.message.reply_text("Ø­Ø¯Ø¯ Ø³Ø¹Ø± Ø¬Ù†ÙŠ Ø§Ù„Ø±Ø¨Ø­ (Take Profit) Ø£Ùˆ Ø£Ø±Ø³Ù„ 0 Ù„ØªØ¬Ø§Ù‡Ù„Ù‡:")
        return TRADE_TP
    except ValueError:
        await update.message.reply_text("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù….")
        return TRADE_SL

async def trade_tp(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        tp = float(update.message.text)
        context.user_data["take_profit"] = tp
    except ValueError:
        context.user_data["take_profit"] = 0

    user_id = update.effective_user.id
    session = user_sessions.get(user_id)
    if not session:
        await update.message.reply_text("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.")
        return ConversationHandler.END
    api_key = session["api_key"]
    api_secret = session["api_secret"]

    # ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø§Ù„ØªØ¯Ø§ÙˆÙ„
    symbol = "BTCUSDT"
    side = context.user_data["side"]
    qty = context.user_data["qty"]
    sl = context.user_data["stop_loss"]
    tp = context.user_data["take_profit"]

    params = {
        "category": "linear",
        "symbol": symbol,
        "side": side,
        "orderType": "Market",
        "qty": qty
    }
    if sl > 0:
        params["stopLoss"] = sl
    if tp > 0:
        params["takeProfit"] = tp

    resp = bybit_request("/v5/order/create", params, api_key, api_secret, req_type="POST")
    if resp.get("retCode") == 0:
        await update.message.reply_text("âœ… ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø© Ø¨Ù†Ø¬Ø§Ø­!")
    else:
        await update.message.reply_text(f"âŒ ÙØ´Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø©: {resp.get('retMsg', 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')}")
    return ConversationHandler.END

# ==== Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù…Ø«Ø§Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ) ====
async def auto_trade(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    session = user_sessions.get(user_id)
    if not session:
        await update.message.reply_text("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.")
        return
    # ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (ÙˆÙ‡Ù…ÙŠ Ù‡Ù†Ø§)
    session["auto_trade"] = not session.get("auto_trade", False)
    status = "Ù…ÙØ¹Ù„ âœ…" if session["auto_trade"] else "Ù…ØªÙˆÙ‚Ù â›”ï¸"
    await update.message.reply_text(f"Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ø¢Ù†: {status}")

# ==== Ø¥Ù„ØºØ§Ø¡ ====
async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡.", reply_markup=main_menu_keyboard())
    return ConversationHandler.END

# ==== ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ====
def main():
    TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "8112822168:AAGwqxRY5xZ23pi5PjEhNkytuXLzjaJ1qVI")
    application = ApplicationBuilder().token(TOKEN).build()

    # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    login_conv = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            API_KEY: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_api_key)],
            API_SECRET: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_api_secret)],
        },
        fallbacks=[CommandHandler('cancel', cancel)]
    )

    # Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
    trade_conv = ConversationHandler(
        entry_points=[
            MessageHandler(filters.Regex("^(ğŸŸ¢ Ø´Ø±Ø§Ø¡|ğŸ”´ Ø¨ÙŠØ¹)$"), trade_action)
        ],
        states={
            TRADE_SIZE: [MessageHandler(filters.TEXT & ~filters.COMMAND, trade_size)],
            TRADE_SL: [MessageHandler(filters.TEXT & ~filters.COMMAND, trade_sl)],
            TRADE_TP: [MessageHandler(filters.TEXT & ~filters.COMMAND, trade_tp)],
        },
        fallbacks=[CommandHandler('cancel', cancel)]
    )

    application.add_handler(login_conv)
    application.add_handler(trade_conv)
    application.add_handler(MessageHandler(filters.Regex("^ğŸ“ˆ Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚$"), market_price))
    application.add_handler(MessageHandler(filters.Regex("^ğŸ’° Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨$"), account_balance))
    application.add_handler(MessageHandler(filters.Regex("^ğŸ” ØªØ¯Ø§ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ$"), auto_trade))
    application.add_handler(MessageHandler(filters.Regex("^ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬$"), logout))

    print("Bot is running...")
    application.run_polling()

if __name__ == "__main__":
    main()
